\section{Purpose and limitations}
The purpose of this document is to serve as an unambigious single resource for reference by administrators of IS-ENES2 ESGF datanodes, to configure their datanodes and publish data in compliance with regulations discussed and adopted by all datanode managers. This document aggregates information from sources such as the Trieste meeting notes \cite{trieste}, Martin Juckes' `CORDEX: ESGF Search Facet Mappings' document \cite{cordexfacetsdoc} and other discussions which have led to collective consensus. This document only contains information from the perspective of publishing/maintaining data on the ESGF datanode and may not be refered to for any other purpose.

\section{Latest Version}
The latest version of this document will always be available at:\\
\url{https://github.com/snic-nsc/datanode-mgr-doc/raw/master/ro/Datanodemgr-doc.pdf} \\
The entire repository, which includes the \LaTeX{} source file can be cloned from:\\
\url{https://github.com/snic-nsc/datanode-mgr-doc.git}


\section{IS-ENES2 ESGF datanode Search Facet Configuration}
IS-ENES2 ESGF datanodes have some additional search facets pertaining to CORDEX. Here below are the entire list of facets used, in an IS-ENES2 ESGF datanode\\
\vspace{1mm}\\
Filename: \texttt{facets.properties}\\
Standard location: \texttt{/esg/config/facets.properties}
\begin{small}
\begin{verbatimtab}[4]
project=0:Project:optional_project_description
institute=1:Institute:optional_institute_description
model=2:Model:optional_model_description
source_id=3:Instrument:optional_instrument_description
experiment_family=4:Experiment Family:optional_experiment_family_description
experiment=5:Experiment:optional_experiment_description
time_frequency=6:Time Frequency:optional_time_frequency_description
product=7:Product:optional_product_description
realm=8:Realm:optional_realm_description
variable=9:Variable:optional_variable_description
variable_long_name=10:Variable Long Name:optional_variable_long_name_description
cmor_table=11:CMIP Table:optional_cmor_table_description
cf_standard_name=12:CF Standard Name:optional_cf_standard_name_description
ensemble=13:Ensemble:optional_ensemble_description
domain=14:Domain:optional_domain_description
driving_model=15:Driving Model:optional_driving_model_description
rcm_version=16:Downscaling realisation:optional_ds_description
data_node=17:Data Node:optional_data_node_description
\end{verbatimtab}
\end{small}
\section{ESGF Attribute Services}
File name: \texttt{esgf\_ats\_static.xml}\\
Standard location: \texttt{/esg/config/esgf\_ats\_static.xml}

\begin{tiny}
\begin{verbatimtab}[4]
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<!-- File that may contain custom attribute service and registration endpoints 
     in addition to those contained in the file esgf_ats.xml. 
     This file is supposed to be maintained by the local system administrators,
     while the file esgf_ats.xml is dynamically generated by the node manager. -->
<ats_whitelist xmlns="http://www.esgf.org/whitelist">

	<!-- pcmdi9 Attribute and Registration services: it is included here to allow registration for "esgf-test" nodes,
	     otherwise it should be contained in file esgf_ats.xml for nodes in the "esgf-prod" group -->
	<attribute type="CMIP5 Research"
               attributeService="https://pcmdi9.llnl.gov/esgf-idp/saml/soap/secure/attributeService.htm"
               description="Users of CMIP5 data for non-commercial research purposes only"
               registrationService="https://pcmdi9.llnl.gov/esgf-idp/secure/registrationService.htm"/>
    <attribute type="CMIP5 Commercial"
               attributeService="https://pcmdi9.llnl.gov/esgf-idp/saml/soap/secure/attributeService.htm"
               description="Users of CMIP5 data for commercial purposes"
               registrationService="https://pcmdi9.llnl.gov/esgf-idp/secure/registrationService.htm"/>

    <attribute type="CORDEX_Commercial" attributeService="https://esg-dn1.nsc.liu.se/esgf-idp/saml/soap/secure/\
	attributeService.htm" description="User group for possible commercial users of CORDEX data" registrationService="\
	https://esg-dn1.nsc.liu.se/esgf-idp/secure/registrationService.htm"/>
    <attribute type="CORDEX_Research" attributeService="https://esg-dn1.nsc.liu.se/esgf-idp/saml/soap/secure/\
	attributeService.htm" description="User group for non-commercial users of CORDEX data only" registrationService="\
	https://esg-dn1.nsc.liu.se/esgf-idp/secure/registrationService.htm"/>
</ats_whitelist>
\end{verbatimtab}
\end{tiny}

\section{ESGF IDP Whitelist settings}
File name: \texttt{esgf\_idp\_static.xml}\\
Standard location: \texttt{/esg/config/esgf\_idp\_static.xml}

\begin{tiny}
\begin{verbatimtab}[4]
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<idp_whitelist xmlns="http://www.esgf.org/whitelist">
	<value>https://cmip-gw.badc.rl.ac.uk/openid/openidserver</value>
	<value>https://ceda.ac.uk/OpenID/Provider/server</value>
	<value>https://ceda.ac.uk/openid/Provider/server</value>
	<value>https://ipcc-ar5.dkrz.de/openid/provider.htm</value>
	<value>https://albedo2.dkrz.de/esgcet/openid/provider.htm</value>
	<value>https://esg-gateway.jpl.nasa.gov/openid/provider.htm</value>
	<value>https://www.earthsystemgrid.org/openid/provider.htm</value>
	<value>https://esg.ucar.edu/openid/provider.htm</value>
	<value>https://esg.nci.org.au/esgcet/openid/provider.htm</value>
	<value>https://esg.nersc.gov/esgcet/openid/provider.htm</value>
	<value>https://esg2-gw.ccs.ornl.gov/esgcet/openid/provider.htm</value>
	<value>https://esg-gw.ornl.teragrid.org/openid/provider.htm</value>
    <value>https://hydra.fsl.noaa.gov/esgf-idp/idp/openidServer.htm</value>
    <value>https://dev-hydra.esrl.svc/esgf-idp/idp/openidServer.htm</value>
    <value>https://pcmdi9.llnl.gov/esgf-idp/idp/openidServer.htm</value>
    <value>https://pcmdi11.llnl.gov/esgf-idp/idp/openidServer.htm</value>
    <value>https://esg-dn1.nsc.liu.se/esgf-idp/idp/openidServer.htm</value>
    <value>https://esg-datanode.jpl.nasa.gov/esgf-idp/idp/openidServer.htm</value>
    <value>https://esgf-data.dkrz.de/esgf-idp/idp/openidServer.htm</value>
    <value>https://esgf-node.ipsl.fr/esgf-idp/idp/openidServer.htm</value>
    <value>https://noresg.norstore.uio.no/esgf-idp/idp/openidServer.htm</value>
	<value>https://esg.bnu.edu.cn/esgf-idp/idp/openidServer.htm</value>
	<value>https://cordexesg.dmi.dk/esgf-idp/idp/openidServer.htm</value>
</idp_whitelist>
\end{verbatimtab}
\end{tiny}

\section{Publication Version}
It was decided at the Trieste meet that all data published on IS-ENES2 datanodes will clearly specify the version number which is the date of the publication, expressed in the format \texttt{yyyymmdd}. This requires the creation of directory with that name, in the physical directory structure. This directory has to be created after the `Variable name' directory. Examples:\\
\begin{tiny}
\texttt{/datapool1/cordexdata/cordex/output/MNA-22/SMHI/ECMWF-ERAINT/evaluation/r0i0p0/SMHI-RCA4/v1/fx/orog/\yellowline{20131101}}\\
\texttt{/datapool1/cordexdata/cordex/output/ARC-44/SMHI/NCC-NorESM1-M/historical/r0i0p0/SMHI-RCA4/v1/fx/sftlf/\yellowline{20140123}}\\
\end{tiny}
\\To get this version number correctly, the procedure is to append a \texttt{\myopt new-version $<$versionnum$>$} to the \texttt{esgpublish} command.

\section{Directory Structure}
The path to the directory tree containing the data shall have \texttt{Project/Product} followed by the directory tree containing the data. \\
Given below are examples of valid and invalid directory structures.\\
\vspace{0mm}\\
\texttt{/cordex/output/...} \cmark\\
\texttt{/localfs/localpath/cordex/output/...} \cmark \footnote{Some sites use the lower-case `cordex' while some use `CORDEX'; While there is no rule, the lower-case `cordex' may be considered as the prefered option.}\footnote{`output' is the value of the `Product' facet option here. It may take other values that are applicable to the `Product' facet in the future.} \\
\texttt{/corddata/output/...} \xmark{ } //non-standard name corresponding to `Project'.  \\ 
\texttt{/cordex/AFR-44/...} \xmark{ } //there is no directory corresponding to `Product'.

\section{Variables to be excluded during publish: CORDEX}

The following declaration inside \texttt{/esg/esgcet/esg.ini} should be used to exclude certain variables from the THREDDS catalogues generated by \texttt{esgpublish}.  Note that this differs from the default value created by previous versions of \texttt{esgsetup}; \yellowline{in particular managers should ensure that the variable \texttt{basin} is NOT excluded.}

\begin{verbatimtab}[4]
thredds_exclude_variables = a, a_bnds, alev1, alevel, alevhalf, alt40, b, \
b_bnds, bnds, bounds_lat, bounds_lon, dbze, depth, depth0m, depth100m, \
depth_bnds, geo_region, height, height10m, height2m, Lambert_Conformal, lat,\
lat_bnds, lat_bounds, latitude, latitude_bnds, layer, lev, lev_bnds, location,\
lon, lon_bnds, lon_bounds, longitude, longitude_bnds, olayer100m, olevel, oline,\
p0, p220, p500, p560, p700, p840, plev, plev3, plev7, plev8, plev_bnds, plevs, \
pressure1, region, rho, rlat, rotated_pole, rlon, scatratio, sdepth, sdepth1, \
sza5, tau, tau_bnds, time, time1, time2, time_bnds, vegtype, x, y
\end{verbatimtab}

\section{Value for the `Model' facet}
It was decided that the value of the `Model' facet should NOT contain the institute information, as this information is already captured and presented by the `Institute' facet.  However, the directory corresponding to the `Model' contains the name of the institute too, along with the model name, as stipulated by the CORDEX archive specifications \footnote{``RCMModelName is an alphanumeric identifier chosen by the modeling group; it should consist of an institute acronym and a model acronym, connected by a dash, e.g., DMI-HIRHAM5 or SMHI-RCA3.''\cite{cordexarchivespecs}}. This results in the requirement for some special handling.
\mypar
The easiest way to handle this is by creating a substitution map for the variable.
\begin{enumerate}
\item Under the options for \texttt{[project:cordex]}, find the configuration line that says \texttt{maps}
\item Edit the line to say the following:\\
\texttt{maps = model\_map,institute\_map, las\_time\_delta\_map, domain\_map}
\item Create a new map `model\_map' and populate it with entries that correspond to  the models that you handle, leaving out the institute part in the last field.
\item Look at the example below for reference:
\begin{verbatimtab}[4]
model_map = map(project,rcm_model : model)
    cordex |SMHI-RCA4| RCA4
    cordex |SMHI-RCA4-SN| RCA4-SN
\end{verbatimtab}
\item Use the regex `model' in the place of the directory corresponding to the model directory, in the \texttt{dataset\_id} string.
\vspace{-6mm}\\
\begin{verbatimtab}[4]
dataset_id = cordex.%(product)s.%(domain)s.%(institute)s.%(driving_model)s.\
%(experiment)s.%(ensemble)s.%(model)s.%(rcm_version)s.%(time_frequency)s.\
%(variable)s
\end{verbatimtab}
\end{enumerate}
\subsection{Complete \texttt{model\_map}}
The current and comprehensive list of CORDEX models may be obtained from:\\
\url{http://cordex.dmi.dk/joomla/images/CORDEX/RCMModelName.txt}. \\
Given below is a script that can generate a complete \texttt{model\_map} table, that could then be pasted into the ini file. Also present is the output of the script.
\begin{tiny}
\begin{verbatimtab}[4]
#!/bin/bash

curl -s 'http://cordex.dmi.dk/joomla/images/CORDEX/RCMModelName.txt'|grep -v '#'|grep 'confirmed'|tr -s ' ' >modelnames.txt
nl=`cat modelnames.txt|wc -l`;
echo "model_map = map(project,rcm_model : model)" >modelmap.txt
for (( i=1; i<=nl; i++ )); do
        ln=`cat modelnames.txt|head -$i|tail -1`;
        inst=`echo $ln|cut -d' ' -f2`;
        res=`echo $ln| sed "s/$inst-\(.*\) \(.*\) confirmed/\tcordex| $inst-\1| \1/"`
        echo -e "$res" >>modelmap.txt;
done

model_map = map(project,rcm_model : model)
        cordex| AUTH-LHTEE-WRF321B| WRF321B
        cordex| AUTH-Met-WRF331A| WRF331A
        cordex| AWI-HIRHAM5| HIRHAM5
        cordex| CCCma-CanRCM4| CanRCM4
        cordex| CHMI-ALADIN52| ALADIN52
        cordex| CLMcom-CCLM4-8-17| CCLM4-8-17
        cordex| CNRM-ALADIN52| ALADIN52
        cordex| CNRM-ARPEGE52| ARPEGE52
        cordex| CRP-GL-WRF331A| WRF331A
        cordex| CUNI-RegCM4-2| RegCM4-2
        cordex| DHMZ-RegCM4-2| RegCM4-2
        cordex| DMI-HIRHAM5| HIRHAM5
        cordex| ENEA-RegCM4-3| RegCM4-3
        cordex| HMS-ALADIN52| ALADIN52
        cordex| ICTP-RegCM4-3| RegCM4-3
        cordex| IDL-WRF331D| WRF331D
        cordex| IPSL-INERIS-WRF331F| WRF331F
        cordex| KNMI-RACMO21P| RACMO21P
        cordex| KNMI-RACMO22T| RACMO22T
        cordex| MIUB-WRF331A| WRF331A
        cordex| MOHC-HadGEM3-RA| HadGEM3-RA
        cordex| MOHC-HadRM3P| HadRM3P
        cordex| MPI-CSC-REMO2009| REMO2009
        cordex| NUIM-WRF331F| WRF331F
        cordex| SMHI-RCA4| RCA4
        cordex| SMHI-RCA4-SN| RCA4-SN
        cordex| SMHI-RCAO| RCAO
        cordex| SMHI-RCAO-SN| RCAO-SN
        cordex| UCAN-WRF331G| WRF331G
        cordex| UCAN-WRF350I| WRF350I
        cordex| UCLM-PROMES| PROMES
        cordex| UHOH-WRF331H| WRF331H
        cordex| UQAM-CRCM5| CRCM5
\end{verbatimtab}
\end{tiny}
\section{Acknowledgments}
Many people have contributed to this document, pointing out errors and suggesting improvements. Thanks in particular to Katharina Berger and Stephanie Legutke of the DKRZ and Stephen Pascoe of the BADC for their suggestions.  Together, we hope to make the task of datanode administration a bit less of a hopeless task, with this reference manual!
